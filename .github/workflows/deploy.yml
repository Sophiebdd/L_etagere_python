name: Deploy (Manual)

on:
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Deploy via SSH
        uses: appleboy/ssh-action@v1.2.1
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.VPS_SSH_KEY }}
          script: |
            set -euo pipefail
            cd ${{ secrets.DEPLOY_PATH }}
            git pull
            docker compose -f docker-compose.prod.yml up -d --build
            CURRENT_REV=$(docker compose -f docker-compose.prod.yml exec -T backend alembic current | grep -Eo '[0-9a-f]+' | head -n1 || true)
            HEAD_REV=$(docker compose -f docker-compose.prod.yml exec -T backend alembic heads | grep -Eo '[0-9a-f]+' | head -n1 || true)
            if [ -z "$CURRENT_REV" ] || [ "$CURRENT_REV" != "$HEAD_REV" ]; then
              DB_INFO=$(docker compose -f docker-compose.prod.yml exec -T backend python -c "import os; from urllib.parse import urlparse; url=os.environ['DATABASE_URL']; p=urlparse(url); print(p.username or ''); print(p.password or ''); print((p.path or '').lstrip('/'))")
              IFS=$'\n' read -r DB_USER DB_PASS DB_NAME <<< "$DB_INFO"
              if [ -z "$DB_USER" ] || [ -z "$DB_PASS" ] || [ -z "$DB_NAME" ]; then
                echo "DATABASE_URL is missing required parts; aborting backup."
                exit 1
              fi
              BACKUP_DIR="/home/ubuntu/backups"
              mkdir -p "$BACKUP_DIR"
              BACKUP_FILE="$BACKUP_DIR/letagere_$(date +%Y%m%d_%H%M%S).sql.gz"
              docker compose -f docker-compose.prod.yml exec -T db \
                sh -c "mysqldump -u '$DB_USER' -p'$DB_PASS' '$DB_NAME'" | gzip > "$BACKUP_FILE"
              ls -1t "$BACKUP_DIR"/letagere_*.sql.gz | tail -n +3 | xargs -r rm -f
              docker compose -f docker-compose.prod.yml exec -T backend alembic upgrade head
            else
              echo "No pending migrations."
            fi
